# Story 3.1: Next.js Infrastructure & Supabase SSR Setup

**Story ID:** 3.1  
**Epic:** Next.js Migration  
**Sprint:** Current  
**Status:** Ready for Development  
**Assigned To:** James (Dev)  
**Created By:** Sarah (Product Owner)  
**Date:** 2025-12-26

---

## Story Description

As a **developer migrating to Next.js**, I need to **initialize the Next.js app directory structure** with root layout, **set up Supabase SSR authentication** using `@supabase/ssr`, and **migrate all environment variables** from `VITE_*` to `NEXT_PUBLIC_*` format, so the **foundation is ready** for migrating all routes and components in subsequent stories.

---

## Acceptance Criteria

### âœ… Must Have

1. **Next.js App Directory Structure**
   - `app/` directory created at project root
   - `app/layout.tsx` created with root layout (replaces App.tsx wrapper)
   - `app/page.tsx` created as placeholder Dashboard route
   - `app/globals.css` created importing existing styles
   - Next.js runs successfully (`npm run dev` starts Next.js server)

2. **Supabase SSR Integration**
   - `@supabase/ssr` package installed
   - `lib/supabase.ts` updated to use `@supabase/ssr` instead of `@supabase/supabase-js`
   - Browser client function created (`createClient()`)
   - Server client function created (`createServerSupabaseClient()`)
   - `contexts/AuthContext.tsx` updated to use new Supabase SSR client
   - Auth flows work identically to current Vite implementation

3. **Environment Variables Migration**
   - All `VITE_*` variables mapped to `NEXT_PUBLIC_*` format
   - `.env.local` updated with new variable names
   - All `import.meta.env.VITE_*` references replaced with `process.env.NEXT_PUBLIC_*`
   - Environment variable validation updated for Next.js
   - No hardcoded environment variable references remain

4. **Next.js Configuration**
   - `next.config.js` created with proper TypeScript and Tailwind setup
   - Import alias `@/*` configured (matches current Vite config)
   - TypeScript paths configured in `tsconfig.json`
   - Build and dev scripts work correctly

5. **Documentation Reference**
   - Story explicitly references `docs/migration-nextjs-blueprint.md`
   - Dev notes follow blueprint guidance
   - Migration path is clear and documented

---

## Technical Implementation Notes (For James)

### ðŸ“š Primary Reference Document

**CRITICAL:** Follow the migration blueprint exactly:
- **File:** `docs/migration-nextjs-blueprint.md`
- **Sections to Reference:**
  - "Next.js Boilerplate Setup" (lines ~200-350)
  - "Supabase Client for Next.js" (lines ~350-400)
  - "Environment Variables" (lines ~400-450)

### Step 1: Install Next.js and Dependencies

```bash
# Install Next.js and Supabase SSR package
npm install next@latest react@latest react-dom@latest
npm install @supabase/ssr@latest

# Install Next.js TypeScript types (if not already installed)
npm install --save-dev @types/node@latest
```

**Note:** Keep existing dependencies (React, Supabase, etc.) - we're adding Next.js alongside Vite initially.

### Step 2: Create Next.js App Directory Structure

**Create `app/` directory:**
```
app/
â”œâ”€â”€ layout.tsx          # Root layout
â”œâ”€â”€ page.tsx            # Dashboard placeholder
â””â”€â”€ globals.css         # Global styles
```

### Step 3: Create Root Layout (`app/layout.tsx`)

**Reference:** `docs/migration-nextjs-blueprint.md` lines ~200-250

```typescript
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/contexts/AuthContext';
import ErrorBoundary from '@/components/ui/ErrorBoundary';
import { OfflineIndicator } from '@/components/ui/OfflineIndicator';
import { CookieConsent } from '@/components/ui/CookieConsent';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'MI Mastery',
  description: 'Motivational Interviewing training with AI-powered patient simulations',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <ErrorBoundary>
          <AuthProvider>
            <OfflineIndicator />
            {children}
            <CookieConsent />
          </AuthProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

### Step 4: Create Global CSS (`app/globals.css`)

```css
/* Import existing styles */
@import '../index.css';
@import '../styles/theme.css';
@import '../styles/design-tokens.css';
```

### Step 5: Create Placeholder Dashboard (`app/page.tsx`)

```typescript
export default function DashboardPage() {
  return (
    <div className="min-h-screen bg-transparent">
      <h1>Next.js Migration - Dashboard Placeholder</h1>
      <p>This will be replaced with actual Dashboard component in Story 3.2</p>
    </div>
  );
}
```

### Step 6: Update Supabase Client (`lib/supabase.ts`)

**Reference:** `docs/migration-nextjs-blueprint.md` lines ~350-400

**CRITICAL:** Replace entire file with Next.js SSR version:

```typescript
import { createBrowserClient, createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// Check if we're in development mode
const isDevelopment = process.env.NODE_ENV === 'development';

// Get Supabase URL from environment variables
const getSupabaseUrl = (): string => {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  
  if (!supabaseUrl) {
    const errorMessage = 'NEXT_PUBLIC_SUPABASE_URL is required but not found. Please set it in your .env.local file.\n\n' +
      'Setup instructions:\n' +
      '1. Create a .env.local file in the project root directory\n' +
      '2. Add this line:\n' +
      '   NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url\n' +
      '3. Get your project URL from: https://app.supabase.com/project/_/settings/api\n' +
      '4. Restart your development server';
    
    if (isDevelopment) {
      console.warn('âš ï¸ [supabase] Supabase URL Missing:', errorMessage);
    }
    console.error('[supabase] Supabase URL check failed');
    throw new Error(errorMessage);
  }
  
  const trimmedUrl = supabaseUrl.trim();
  if (!trimmedUrl || trimmedUrl.length === 0) {
    const errorMessage = 'NEXT_PUBLIC_SUPABASE_URL is set but appears to be empty. Please check your .env.local file.';
    if (isDevelopment) {
      console.warn('âš ï¸ [supabase] Invalid Supabase URL:', errorMessage);
    }
    throw new Error(errorMessage);
  }
  
  if (isDevelopment) {
    console.log('[supabase] Supabase URL found:', trimmedUrl);
  }
  
  return trimmedUrl;
};

// Get Supabase anonymous key from environment variables
const getSupabaseAnonKey = (): string => {
  const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
  
  if (!anonKey) {
    const errorMessage = 'NEXT_PUBLIC_SUPABASE_ANON_KEY is required but not found. Please set it in your .env.local file.\n\n' +
      'Setup instructions:\n' +
      '1. Create a .env.local file in the project root directory\n' +
      '2. Add this line:\n' +
      '   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key\n' +
      '3. Get your anon key from: https://app.supabase.com/project/_/settings/api\n' +
      '4. Restart your development server';
    
    if (isDevelopment) {
      console.warn('âš ï¸ [supabase] Supabase Anon Key Missing:', errorMessage);
    }
    console.error('[supabase] Supabase anon key check failed');
    throw new Error(errorMessage);
  }
  
  const trimmedKey = anonKey.trim();
  if (!trimmedKey || trimmedKey.length === 0) {
    const errorMessage = 'NEXT_PUBLIC_SUPABASE_ANON_KEY is set but appears to be empty. Please check your .env.local file.';
    if (isDevelopment) {
      console.warn('âš ï¸ [supabase] Invalid Supabase Anon Key:', errorMessage);
    }
    throw new Error(errorMessage);
  }
  
  if (isDevelopment) {
    console.log('[supabase] Supabase anon key found:', {
      hasKey: true,
      keyLength: trimmedKey.length,
      keyPrefix: `${trimmedKey.substring(0, 20)}...`
    });
  }
  
  return trimmedKey;
};

// Check if Supabase is configured (lazy check)
export const isSupabaseConfigured = (): boolean => {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
  
  const hasUrl = !!(supabaseUrl && supabaseUrl.trim());
  const hasKey = !!(supabaseAnonKey && supabaseAnonKey.trim());
  
  return hasUrl && hasKey;
};

/**
 * Create browser client for client components
 * Use this in client components and hooks
 */
export function createClient() {
  return createBrowserClient(
    getSupabaseUrl(),
    getSupabaseAnonKey()
  );
}

/**
 * Create server client for server components and server actions
 * Use this in server components and API routes
 */
export async function createServerSupabaseClient() {
  const cookieStore = await cookies();
  
  return createServerClient(
    getSupabaseUrl(),
    getSupabaseAnonKey(),
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch (error) {
            // Handle error silently in server context
            console.error('[supabase] Error setting cookies:', error);
          }
        },
      },
    }
  );
}

// Legacy export for backwards compatibility (use createClient() instead)
let browserClient: ReturnType<typeof createBrowserClient> | null = null;

export const getSupabaseClient = () => {
  if (!browserClient) {
    browserClient = createClient();
  }
  return browserClient;
};

// Export as default for backwards compatibility
export { getSupabaseClient as supabase };
```

### Step 7: Update AuthContext (`contexts/AuthContext.tsx`)

**Reference:** `docs/migration-nextjs-blueprint.md` - Auth integration section

**Key Changes:**
1. Add `'use client'` directive at top of file
2. Replace `getSupabaseClient()` calls with `createClient()` from new supabase.ts
3. Keep all existing auth logic (signIn, signUp, signOut, etc.)

```typescript
'use client';

import React, { createContext, useContext, useEffect, useState } from 'react';
import { User } from '@supabase/supabase-js';
import { createClient, isSupabaseConfigured } from '@/lib/supabase';

// ... rest of existing AuthContext code ...
// Replace getSupabaseClient() with createClient() throughout
```

### Step 8: Update Environment Variables

**Reference:** `docs/migration-nextjs-blueprint.md` lines ~400-450

**Find & Replace All Files:**

1. **`.env.local` file:**
```bash
# OLD (Vite format)
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
VITE_STRIPE_PUBLISHABLE_KEY=your_stripe_key

# NEW (Next.js format)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_key
```

2. **Find all `import.meta.env.VITE_*` references:**
```bash
# Search for all occurrences
grep -r "import.meta.env.VITE_" --include="*.ts" --include="*.tsx"
```

3. **Replace with `process.env.NEXT_PUBLIC_*`:**
   - `import.meta.env.VITE_SUPABASE_URL` â†’ `process.env.NEXT_PUBLIC_SUPABASE_URL`
   - `import.meta.env.VITE_SUPABASE_ANON_KEY` â†’ `process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY` â†’ `process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
   - `import.meta.env.VITE_GEMINI_API_KEY` â†’ `process.env.NEXT_PUBLIC_GEMINI_API_KEY` (if used client-side)
   - `import.meta.env.DEV` â†’ `process.env.NODE_ENV === 'development'`

**Files to Update:**
- `lib/supabase.ts` (already updated in Step 6)
- `services/stripeService.ts`
- `hooks/useSetupCheck.ts`
- `components/views/PracticeView.tsx` (if uses env vars)
- Any other files found in grep search

### Step 9: Create Next.js Configuration (`next.config.js`)

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  // Import alias configuration
  webpack: (config) => {
    config.resolve.alias = {
      ...config.resolve.alias,
      '@': require('path').resolve(__dirname, '.'),
    };
    return config;
  },
};

module.exports = nextConfig;
```

### Step 10: Update TypeScript Configuration (`tsconfig.json`)

**Add Next.js paths:**
```json
{
  "compilerOptions": {
    // ... existing options ...
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ]
}
```

### Step 11: Update Package.json Scripts

**Add Next.js scripts (keep Vite scripts for now):**
```json
{
  "scripts": {
    "dev": "next dev",
    "dev:vite": "vite",  // Keep old Vite dev for reference
    "build": "next build",
    "build:vite": "vite build",  // Keep old Vite build for reference
    "start": "next start",
    "lint": "next lint",
    "functions:serve": "supabase functions serve --env-file .env.local",
    "functions:deploy": "supabase functions deploy",
    "generate-icons": "node scripts/generate-icons-from-logo.js"
  }
}
```

### Step 12: Create Next.js Environment Types (`next-env.d.ts`)

**File:** `next-env.d.ts` (auto-generated, but verify it exists)

```typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// It is automatically updated when running `next dev` or `next build`
```

### Edge Cases to Handle

1. **Environment Variable Access:**
   - Client-side: Use `process.env.NEXT_PUBLIC_*` (must have `NEXT_PUBLIC_` prefix)
   - Server-side: Use `process.env.*` (no prefix needed for server-only vars)

2. **Supabase Client Usage:**
   - Client components/hooks: Use `createClient()` from `lib/supabase.ts`
   - Server components: Use `createServerSupabaseClient()` from `lib/supabase.ts`
   - AuthContext: Must use `createClient()` (it's a client component)

3. **Mock Mode:**
   - Keep existing mock authentication fallback logic
   - Ensure `isSupabaseConfigured()` works with new env var names

4. **Development vs Production:**
   - `process.env.NODE_ENV` replaces `import.meta.env.DEV`
   - Check: `process.env.NODE_ENV === 'development'`

### Testing Checklist

- [ ] Next.js dev server starts successfully (`npm run dev`)
- [ ] Root layout renders without errors
- [ ] Placeholder Dashboard page accessible at `/`
- [ ] Supabase client initializes correctly
- [ ] AuthContext works with new Supabase SSR client
- [ ] Login flow works (sign in, sign up, sign out)
- [ ] Environment variables load correctly
- [ ] No `import.meta.env` references remain
- [ ] No `VITE_*` environment variable references remain
- [ ] TypeScript compilation succeeds
- [ ] Build succeeds (`npm run build`)

---

## Design Notes

- **Backwards Compatibility:** Keep Vite config and scripts for reference during migration
- **Incremental Migration:** This story sets foundation; routes migrate in subsequent stories
- **Auth Preservation:** Auth flows must work identically to current Vite implementation
- **Environment Safety:** All env var validation must work in Next.js context

---

## Dependencies

- âœ… `docs/migration-nextjs-blueprint.md` (PRIMARY REFERENCE - follow exactly)
- âœ… `lib/supabase.ts` (current implementation to migrate)
- âœ… `contexts/AuthContext.tsx` (current implementation to update)
- âœ… `.env.local` (environment variables to migrate)
- âœ… `package.json` (add Next.js dependencies)
- âœ… `tsconfig.json` (update paths configuration)

---

## Definition of Done

- [ ] Next.js app directory structure created
- [ ] Root layout (`app/layout.tsx`) created and functional
- [ ] Placeholder Dashboard (`app/page.tsx`) accessible
- [ ] `@supabase/ssr` package installed and integrated
- [ ] `lib/supabase.ts` updated to use `@supabase/ssr`
- [ ] `contexts/AuthContext.tsx` updated to use new Supabase client
- [ ] All environment variables migrated (`VITE_*` â†’ `NEXT_PUBLIC_*`)
- [ ] All `import.meta.env` references replaced with `process.env`
- [ ] `next.config.js` created with proper configuration
- [ ] `tsconfig.json` updated with Next.js paths
- [ ] Package.json scripts updated
- [ ] Next.js dev server runs successfully
- [ ] Auth flows work identically to Vite version
- [ ] No console errors or warnings
- [ ] TypeScript compilation succeeds
- [ ] Build succeeds without errors

---

## Questions for Architect

1. Should we keep Vite running in parallel during migration, or fully switch to Next.js?
2. Do we need to update Edge Functions to use new environment variable names?
3. Should we create a migration branch or migrate directly in main branch?

---

## References

- **PRIMARY REFERENCE:** `docs/migration-nextjs-blueprint.md` - Follow this blueprint exactly
- **Next.js Docs:** https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations
- **Supabase SSR Docs:** https://supabase.com/docs/guides/auth/server-side/nextjs

---

**Story Ready for Development** âœ…  
**Dev Notes Complete** âœ…  
**Blueprint Reference Documented** âœ…

---

## Story Draft Checklist âœ…

### Story Structure
- [x] Story ID and metadata complete (3.1, Epic, Sprint, Status, Assignee)
- [x] User story format follows "As a... I need... So that..." pattern
- [x] Acceptance criteria are specific and testable
- [x] Story is scoped appropriately (infrastructure setup only)

### Technical Clarity
- [x] Files to create/modify are clearly identified
- [x] Dependencies are listed and verified
- [x] Code examples provided for all key files
- [x] Step-by-step implementation guide provided
- [x] Primary reference document (`docs/migration-nextjs-blueprint.md`) explicitly referenced

### Implementation Guidance
- [x] Step-by-step instructions for Next.js setup
- [x] Supabase SSR integration explained
- [x] Environment variable migration documented
- [x] Edge cases documented (client vs server, mock mode, etc.)
- [x] Testing checklist provided

### Design & Architecture
- [x] Migration strategy explained (incremental, backwards compatible)
- [x] File structure documented
- [x] Configuration requirements clear

### Completeness
- [x] All 3 main requirements covered (boilerplate, auth, env vars)
- [x] Next.js configuration explained
- [x] TypeScript configuration explained
- [x] Package.json updates documented
- [x] Questions for Architect documented

### Developer Readiness
- [x] James (Dev) can implement without reading external docs (except blueprint)
- [x] All code snippets are copy-paste ready
- [x] File paths are correct and verified
- [x] Import statements provided
- [x] No ambiguous requirements
- [x] Blueprint reference explicitly stated

### Definition of Done
- [x] DoD checklist provided
- [x] Testing requirements clear
- [x] Code quality requirements defined
- [x] Migration completeness verified

---

**Checklist Status:** âœ… **PASSED**  
**Story Quality:** âœ… **READY FOR DEVELOPMENT**  
**Dev Notes Completeness:** âœ… **100% - Blueprint Reference Included**

**Validated By:** Sarah (Product Owner)  
**Date:** 2025-12-26
